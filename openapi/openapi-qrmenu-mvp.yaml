openapi: 3.1.0
info:
  title: QRMenu API - MVP
  version: 1.0.0
  description: |
    Public & Admin API for QR-based menu and ordering (MVP).
    Scopes:
      - Public (no auth): resolve table, get menu, create guest order
      - Admin (JWT cookie): login, manage menu, list & update orders
servers:
  # - url: https://api.example.com
  # description: Production
  - url: http://localhost:8080
    description: Local Dev

tags:
  - name: Public
  - name: Admin
  - name: Menu
  - name: Orders

components:
  securitySchemes:
    AdminCookieAuth:
      type: apiKey
      in: cookie
      name: admin_token
  schemas:
    Error:
      type: object
      properties:
        error: { type: string }
      required: [error]
    Tenant:
      type: object
      properties:
        id: { type: string, format: uuid }
        code: { type: string }
        name: { type: string }
        logo_url: { type: string, format: uri, nullable: true }
        theme: { type: object, additionalProperties: true, nullable: true }
    Table:
      type: object
      properties:
        id: { type: string, format: uuid }
        code: { type: string }
        name: { type: string }
        token: { type: string }
    Category:
      type: object
      properties:
        id: { type: string, format: uuid }
        name: { type: string }
        sort: { type: integer }
        is_active: { type: boolean }
    Item:
      type: object
      properties:
        id: { type: string, format: uuid }
        category_id: { type: string, format: uuid }
        name: { type: string }
        description: { type: string, nullable: true }
        price: { type: integer, description: "Price in IDR (rupiah)" }
        photo_url: { type: string, format: uri, nullable: true }
        flags:
          type: object
          additionalProperties: true
        is_active: { type: boolean }
    OrderStatus:
      type: string
      enum: [waiting, processing, delivering, done, canceled]
    PaidStatus:
      type: string
      enum: [unpaid, paid]
    OrderItemCreate:
      type: object
      properties:
        item_id: { type: string, format: uuid }
        qty: { type: integer, minimum: 1 }
        options:
          type: object
          additionalProperties: true
      required: [item_id, qty]
    OrderCreateRequest:
      type: object
      properties:
        tenant: { type: string, description: "Tenant code" }
        table_token: { type: string }
        guest_session_id: { type: string }
        note: { type: string, nullable: true }
        items:
          type: array
          items: { $ref: "#/components/schemas/OrderItemCreate" }
      required: [tenant, table_token, guest_session_id, items]
    Order:
      type: object
      properties:
        id: { type: string, format: uuid }
        tenant_id: { type: string, format: uuid }
        table_id: { type: string, format: uuid }
        status: { $ref: "#/components/schemas/OrderStatus" }
        paid_status: { $ref: "#/components/schemas/PaidStatus" }
        note: { type: string, nullable: true }
        created_at: { type: string, format: date-time }
        items:
          type: array
          items:
            type: object
            properties:
              id: { type: string, format: uuid }
              item_id: { type: string, format: uuid }
              name: { type: string }
              qty: { type: integer }
              unit_price: { type: integer }
              options:
                type: object
                additionalProperties: true
    OrdersPaged:
      type: object
      properties:
        data:
          type: array
          items: { $ref: "#/components/schemas/Order" }
        next_cursor: { type: string, nullable: true }

paths:
  /health:
    get:
      summary: Health check
      tags: [Public]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { type: string }

  /api/v1/table/{token}:
    get:
      summary: Resolve table token to tenant & table
      tags: [Public]
      parameters:
        - in: path
          name: token
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Table & tenant info
          content:
            application/json:
              schema:
                type: object
                properties:
                  tenant: { $ref: "#/components/schemas/Tenant" }
                  table: { $ref: "#/components/schemas/Table" }
        "404":
          description: Not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }

  /api/v1/menu:
    get:
      summary: Get menu by tenant code
      tags: [Public, Menu]
      parameters:
        - in: query
          name: tenant
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Menu payload
          content:
            application/json:
              schema:
                type: object
                properties:
                  tenant: { type: string }
                  categories:
                    type: array
                    items: { $ref: "#/components/schemas/Category" }
                  items:
                    type: array
                    items: { $ref: "#/components/schemas/Item" }
        "404":
          description: Tenant not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }

  /api/v1/orders:
    post:
      summary: Create a guest order
      tags: [Public, Orders]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/OrderCreateRequest" }
            examples:
              simple:
                value:
                  tenant: demo-tenant
                  table_token: tb-01
                  guest_session_id: abc123
                  note: "no sugar"
                  items:
                    - item_id: 11111111-1111-1111-1111-111111111111
                      qty: 1
                    - item_id: 22222222-2222-2222-2222-222222222222
                      qty: 2
      responses:
        "201":
          description: Order created
          content:
            application/json:
              schema:
                type: object
                properties:
                  order_id: { type: string, format: uuid }
                  status: { $ref: "#/components/schemas/OrderStatus" }
        "400":
          description: Invalid payload
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }

  /auth/login:
    post:
      summary: Admin login (sets HttpOnly cookie)
      tags: [Admin]
      requestBody:
        required: false
      responses:
        "200":
          description: Logged in
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }

  /admin/orders:
    get:
      summary: List orders (admin)
      tags: [Admin, Orders]
      security: [{ AdminCookieAuth: [] }]
      parameters:
        - in: query
          name: status
          schema: { $ref: "#/components/schemas/OrderStatus" }
        - in: query
          name: cursor
          schema: { type: string }
      responses:
        "200":
          description: Orders page
          content:
            application/json:
              schema: { $ref: "#/components/schemas/OrdersPaged" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }

  /admin/orders/{id}/status:
    patch:
      summary: Update order status
      tags: [Admin, Orders]
      security: [{ AdminCookieAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status: { $ref: "#/components/schemas/OrderStatus" }
              required: [status]
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Order" }
        "400":
          description: Invalid transition
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }
        "404":
          description: Order not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Error" }

  /admin/categories:
    get:
      summary: List categories
      tags: [Admin, Menu]
      security: [{ AdminCookieAuth: [] }]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Category" }
    post:
      summary: Create category
      tags: [Admin, Menu]
      security: [{ AdminCookieAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string }
                sort: { type: integer }
                is_active: { type: boolean }
              required: [name]
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Category" }

  /admin/items:
    get:
      summary: List items
      tags: [Admin, Menu]
      security: [{ AdminCookieAuth: [] }]
      parameters:
        - in: query
          name: category_id
          schema: { type: string, format: uuid }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Item" }
    post:
      summary: Create item
      tags: [Admin, Menu]
      security: [{ AdminCookieAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                category_id: { type: string, format: uuid }
                name: { type: string }
                description: { type: string }
                price: { type: integer }
                photo_url: { type: string, format: uri }
                is_active: { type: boolean }
              required: [category_id, name, price]
      responses:
        "201":
          description: Created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Item" }
